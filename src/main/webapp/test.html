<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>测试页面</title>
	<script type="text/javascript" src="http://localhost:8080/static/js/jquery-1.12.4.min.js"></script>
	<link href="http://localhost:8080/static/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet">
	<script src="http://localhost:8080/static/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
	<script type="text/javascript">
		 var totalRecord,currentPage;
		//1、页面加载完成以后，直接去发送ajax请求,要到分页数据
		$(function(){
			
			//去首页
			to_page(1);
			var u=$("#u").val();
			if(u!=null&&u!=""){
				$("#login").html("");
			}
			
			$("#check_all").attr("checked",false);
		});
		
		//申明一个方法用来显示模糊查询
		function to_page(pn){
			var name=$("#name").val();
			  var btype=$("#btype").val();
			  var b_date=$("#b_date").val();
			  var h_date=$("#h_date").val();
			  var b_dates=$("#b_dates").val();
			  var h_dates=$("#h_dates").val();
			  alert(b_date);
			$.ajax({
				url:"classify/showClassify.action",
				type:"POST",
				data:{"pn":pn,"itemno":name,"objecttype":btype,"lowevaluatescore":b_date,"highevaluatescore":h_date,"lowitemvalue":b_dates,"highitemvalue":h_dates},
				dataType:'json',
				
				success:function(result){
					console.log(result);
					//1、解析并显示数据
					build_book_table(result);
					//2、解析并显示分页信息
					build_page_info(result);
					//3、解析显示分页条数据
					build_page_nav(result);
				}
			});
			$("#check_all").attr("checked",false);
		}

 function build_book_table(result){
	//清空table表格
	$("#book_table tbody").empty();
	alert(result);
	var book = result;
	$.each(book,function(index,item){
		var checkBoxTd = $("<td><input type='checkbox' class='check_item'/></td>");
		var serialno = $("<td></td>").append(item.serialno);
		var itemno = $("<td></td>").append(item.itemno);
		var booktype = $("<td></td>").append(item.booktype);
		var objecttype = $("<td></td>").append(item.objecttype);
		var evaluatescore = $("<td></td>").append(item.evaluatescore);
		var itemvalue = $("<td></td>").append(item.itemvalue);
	

	var editBtn = $("<button></button>").addClass("btn btn-primary btn-sm edit_btn")
		.append($("<span></span>").addClass("glyphicon glyphicon-pencil")).append("编辑");
	//为编辑按钮添加一个自定义的属性，来表示当前id
	editBtn.attr("edit-id",item.bookid);
	var delBtn =  $("<button></button>").addClass("btn btn-danger btn-sm delete_btn")
		.append($("<span></span>").addClass("glyphicon glyphicon-trash")).append("删除");
	//为删除按钮添加一个自定义的属性来表示当前删除的id
	delBtn.attr("del-id",item.bookid);
	var btnTd = $("<td></td>").append(editBtn).append(" ").append(delBtn);

		//append方法执行完成以后还是返回原来的元素
		$("<tr></tr>").append(checkBoxTd)
			.append(serialno)
			.append(itemno)
			.append(objecttype)
			.append(evaluatescore)
			.append(itemvalue)
			/* .append(bookcount)*/
			.append(btnTd) 
			.appendTo("#book_table tbody");
	 }); 
	
}
//解析显示分页信息
function build_page_info(result){
	$("#page_info_area").empty();

	$("#page_info_area").append("当前"+result.extend.pageInfo.pageNum+"页,总"+
			result.extend.pageInfo.pages+"页,总"+
			result.extend.pageInfo.total+"条记录");
	totalRecord = result.extend.pageInfo.total;
	currentPage = result.extend.pageInfo.pageNum;
}
//解析显示分页条，点击分页要能去下一页....
function build_page_nav(result){
	//page_nav_area
	$("#page_nav_area").empty();
	var ul = $("<ul></ul>").addClass("pagination");
	
	//构建元素
	var firstPageLi = $("<li></li>").append($("<a></a>").append("首页").attr("href","javascript:void(0)"));
	var prePageLi = $("<li></li>").append($("<a></a>").append("&laquo;"));
	if(result.extend.pageInfo.hasPreviousPage == false){
		firstPageLi.addClass("disabled");
		prePageLi.addClass("disabled");
	}else{
		//为元素添加点击翻页的事件
		firstPageLi.click(function(){
			to_page(1);
		});
		prePageLi.click(function(){
			to_page(result.extend.pageInfo.pageNum -1);
		});
	}
	
	var nextPageLi = $("<li></li>").append($("<a></a>").append("&raquo;"));
	var lastPageLi = $("<li></li>").append($("<a></a>").append("末页").attr("href","javascript:void(0)"));
	if(result.extend.pageInfo.hasNextPage == false){
		nextPageLi.addClass("disabled");
		lastPageLi.addClass("disabled");
	}else{
		nextPageLi.click(function(){
			to_page(result.extend.pageInfo.pageNum +1);
		});
		lastPageLi.click(function(){
			to_page(result.extend.pageInfo.pages);
		});
	}
	
	//添加首页和前一页 的提示
	ul.append(firstPageLi).append(prePageLi);
	//1,2，3遍历给ul中添加页码提示
	$.each(result.extend.pageInfo.navigatepageNums,function(index,item){
		
		var numLi = $("<li></li>").append($("<a></a>").append(item));
		if(result.extend.pageInfo.pageNum == item){
			numLi.addClass("active");
		}
		numLi.click(function(){
			to_page(item);
		});
		ul.append(numLi);
	});
	//添加下一页和末页 的提示
	ul.append(nextPageLi).append(lastPageLi);
	
	//把ul加入到nav
	var navEle = $("<nav></nav>").append(ul);
	navEle.appendTo("#page_nav_area");
}
//单个删除
$(document).on("click",".delete_btn",function(){
	var u=$("#u").val();
	if(u==null||u==""){
		location.href="login.html";
	}else{
	//1、弹出是否确认删除对话框
	var bookname = $(this).parents("tr").find("td:eq(2)").text();
	var bookid = $(this).attr("del-id");
	alert(bookid);
	if(confirm("确认删除【"+bookname+"】吗？")){
		//确认，发送ajax请求删除即可
		$.ajax({
			url:"${APP_PATH}/bk/del/"+bookid,
			type:"DELETE",
			success:function(result){
				alert(result.msg);
				//回到本页
				to_page(currentPage);
			}
		});
	}
	}
});

//完成全选/全不选功能
	$(document).on("click","#check_all",function(){	
		
	//attr获取checked是undefined;
	//我们这些dom原生的属性；attr获取自定义属性的值；
	//prop修改和读取dom原生属性的值
	$(".check_item").prop("checked",$(this).prop("checked"));
});

//check_item
$(document).on("click",".check_item",function(){
	
	//判断当前选择中的元素是否5个
	var flag = $(".check_item:checked").length==$(".check_item").length;
	$("#check_all").prop("checked",flag);
	
});

//点击全部删除，就批量删除
//$("#book_delete_all_btn").click(function(){
	$(document).on("click","#book_delete_all_btn",function(){
		var u=$("#u").val();
		if(u==null||u==""){
			location.href="login.jsp";
		}else{
	//alert("ss");
	var bookname = "";
	var del_idstr = "";
	$.each($(".check_item:checked"),function(){
		//this
		bookname += $(this).parents("tr").find("td:eq(2)").text()+",";
		//组装id字符串
		del_idstr += $(this).parents("tr").find("td:eq(1)").text()+"-";
	});
	//去除bookname多余的,
	bookname = bookname.substring(0,bookname.length-1);
	//去除删除的id多余的-
	del_idstr = del_idstr.substring(0, del_idstr.length-1);
	//alert(del_idstr);
	if(confirm("确认删除【"+bookname+"】吗？")){
		//发送ajax请求删除
		$.ajax({
			url:"${APP_PATH}/bk/del/"+del_idstr,
			type:"DELETE",
			success:function(result){
				alert(result.msg);
				//回到当前页面
				to_page(currentPage);
			}
		});
	}
		}
});
	

	//点击新增按钮
	//$("#book_add_modal_btn").click(function(){
		 $(document).on("click","#book_add_modal_btn",function(){

		location.href="risk-record-detail.html";
		
	}); 
		 $(document).on("click",".edit_btn",function(){
			
			var bookid = $(this).attr("edit-id");
			//alert(bookid); 
			//alert("${APP_PATH}/bk/pre/bookid="+bookid);
			location.href="${APP_PATH}/bk/pre/"+bookid;
			//to_page(currentPage);
			
			/*  $.ajax({
				url:"${APP_PATH}/bk/pre/"+bookid,
				type:"GET",
				success:function(result){
					//alert(result.msg);
				
					location.href="edit.jsp";
					//to_page(currentPage);
				}
			});  
  */
		}); 
		 
</script>
</head>
<body>
	<!-- 搭建显示页面 -->
	
		<!-- 标题 -->
		<div class="row">
			<div class="col-md-12">
				<h1>图书管理系统</h1>
			</div>
		</div>

&nbsp;&nbsp;&nbsp;&nbsp;<a href="uc/cl"><font size="5" id="login">请登录</font></a>
		<!-- 按钮 -->
		<div class="row">
		 <form action="" method="post">
		 
		<input type="hidden" id="u" value="${u}" name="u">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		项目编号:<input type="text" id="name" name="name">&nbsp;&nbsp;&nbsp;
		评审类型:<input type="text" id="btype" name="btype">&nbsp;&nbsp;&nbsp;
		评估值:<input type="text" id="b_date" name="highevaluatescore" style="width: 70px;">&nbsp;-&nbsp;<input type="text" id="h_date" style="width: 70px;" name="highevaluatescore">&nbsp;&nbsp;&nbsp;&nbsp;
		项目值: <input  type="text" id="b_dates" name="lowitemvalue" style="width: 70px;">&nbsp;-&nbsp;<input type="text" id="h_dates" style="width: 70px;" name="highitemvalue">&nbsp;&nbsp;&nbsp;&nbsp;
		
	<input type="button" value="搜索" id="search" onclick="to_page('1')" >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			 </form> 
			
			<div class="col-md-4 col-md-offset-8">
				<button type="button" class="btn btn-primary" id="book_add_modal_btn" >新增</button>
				<button type="button" class="btn btn-danger" id="book_delete_all_btn">删除</button>
			</div>
		</div>
		<!-- 显示表格数据 -->
				<table class="table table-hover"   id="book_table">
				<thead>
					<tr>
						<th>
								<input type="checkbox" id="check_all" />
						</th>
						<th>流水号</th>
						<th>项目编号</th>
						<th>贷款类型</th>
						<th>评估值</th>
						<th>项目值</th>
						<!-- <th>审批人</th>
						<th>审批时间</th> -->
						<th>操作</th>
					</tr>
					<thead>
				<tbody>
					
					
					</tbody>
					
				</table>
			<!-- 显示分页信息 -->
		<div class="row">
			<!--分页文字信息  -->
			<div class="col-md-6" id="page_info_area"></div>
			<!-- 分页条信息 -->
			<div class="col-md-6" id="page_nav_area">
				
			</div>
		</div>

</body>
</html>
